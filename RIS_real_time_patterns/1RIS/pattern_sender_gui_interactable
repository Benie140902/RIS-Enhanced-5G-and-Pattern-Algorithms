import sys
import serial
import pandas as pd
from PyQt5.QtCore import QTimer
from PyQt5.QtWidgets import (
    QApplication, QWidget, QGridLayout, QPushButton,
    QVBoxLayout, QHBoxLayout, QComboBox
)

PORT = '/dev/ttyUSB0'
BAUD_RATE = 115200
DELAY_BETWEEN_PATTERNS = 3000


def hex_to_matrix(hex_str):
    hex_str = hex_str[3:]  # Remove !0X
    matrix = [[0] * 16 for _ in range(16)]
    for col in range(16):
        bits = bin(int(hex_str[col * 4:(col + 1) * 4], 16))[2:].zfill(16)
        for row in range(16):
            matrix[row][col] = int(bits[row])
    return matrix


def matrix_to_hex(matrix):
    """Convert 16x16 binary matrix back to !0X.... hex string."""
    hex_str = "!0X"
    for col in range(16):
        bits = "".join(str(matrix[row][col]) for row in range(16))
        hex_str += f"{int(bits, 2):04X}"
    return hex_str


class PatternSender(QWidget):
    def __init__(self):
        super().__init__()
        self.setWindowTitle("RIS Pattern Visualizer")
        self.resize(500, 550)
        self.grid_size = 16
        self.pattern_index = 0
        self.is_paused = False
        self.ser = serial.Serial(PORT, BAUD_RATE, timeout=2)

        # Load patterns
        self.full_patterns = self.load_patterns_from_excel("40.xlsx")
        self.patterns = self.full_patterns.copy()

        # Current custom pattern (start with first pattern)
        self.current_matrix = hex_to_matrix(self.patterns[0]['Pattern'])

        self.init_ui()

        self.timer = QTimer()
        self.timer.timeout.connect(self.auto_advance)
        self.timer.start(DELAY_BETWEEN_PATTERNS)

    def load_patterns_from_excel(self, path):
        df = pd.read_excel(path)
        return df.to_dict(orient='records')

    def init_ui(self):
        main_layout = QVBoxLayout()
        self.grid_layout = QGridLayout()
        self.cells = []

        for row in range(self.grid_size):
            row_cells = []
            for col in range(self.grid_size):
                cell = QPushButton("")
                cell.setFixedSize(25, 25)
                cell.setStyleSheet("background-color: white; border: 1px solid #ccc;")
                # --- make clickable ---
                cell.clicked.connect(lambda _, r=row, c=col: self.toggle_cell(r, c))
                self.grid_layout.addWidget(cell, row, col)
                row_cells.append(cell)
            self.cells.append(row_cells)

        # Control layout
        control_layout = QHBoxLayout()
        self.dropdown = QComboBox()
        unique_powers = sorted(set(int(p['Power (dB)']) for p in self.full_patterns))
        self.dropdown.addItems([str(p) for p in unique_powers])
        self.dropdown.currentTextChanged.connect(self.filter_by_power)

        btn_prev = QPushButton("Previous")
        btn_prev.clicked.connect(self.send_prev_pattern)
        btn_pause = QPushButton("Pause/Resume")
        btn_pause.clicked.connect(self.toggle_pause)
        btn_next = QPushButton("Next")
        btn_next.clicked.connect(self.send_next_pattern)
        control_layout.addWidget(self.dropdown)

        control_layout.addWidget(btn_prev)
        control_layout.addWidget(btn_pause)
        control_layout.addWidget(btn_next)

        main_layout.addLayout(self.grid_layout)
        main_layout.addLayout(control_layout)
        self.setLayout(main_layout)

        # Show first pattern
        self.update_grid(self.current_matrix)

    def auto_advance(self):
        if not self.is_paused:
            self.send_next_pattern()

    def toggle_pause(self):
        self.is_paused = not self.is_paused

    def send_prev_pattern(self):
        if self.pattern_index > 0:
            self.pattern_index -= 1
            self.load_pattern(self.pattern_index)

    def send_next_pattern(self):
        if self.pattern_index < len(self.patterns):
            self.load_pattern(self.pattern_index)
            self.pattern_index += 1
        else:
            self.timer.stop()
            self.ser.close()
            print("Finished all patterns.")

    def load_pattern(self, index):
        """Load a stored pattern from Excel and send it"""
        data = self.patterns[index]
        self.current_matrix = hex_to_matrix(data['Pattern'])
        self.send_current_matrix(from_excel=True,
                                 index=data['Pattern Index'],
                                 power=data['Power (dB)'])

    def send_current_matrix(self, from_excel=False, index=None, power=None):
        """Send current pattern (Excel or manual edit) to RIS"""
        pattern_hex = matrix_to_hex(self.current_matrix)

        if from_excel and index is not None and power is not None:
            # Keep the same format as Excel
            print(f"Sending Pattern Index: {index} | Power: {power:.2f} dB")
        else:
            # Manual toggle format (fake index/power)
            print("Sending Pattern Index: -1 | Power: N/A (Manual Edit)")

        print(pattern_hex)

        # --- Send to RIS ---
        self.ser.write((pattern_hex + '\n').encode())
        try:
            response = self.ser.readline().decode().strip()
            print(f"RIS Response: {response}")
        except Exception as e:
            print(f"No response or decode error: {e}")

        self.update_grid(self.current_matrix)

    def update_grid(self, matrix):
        for row in range(self.grid_size):
            for col in range(self.grid_size):
                color = "green" if matrix[row][col] else "white"
                self.cells[row][col].setStyleSheet(
                    f"background-color: {color}; border: 1px solid #ccc;"
                )

    def filter_by_power(self, value):
        try:
            target = int(value)
            self.patterns = [p for p in self.full_patterns if int(p['Power (dB)']) == target]
            self.pattern_index = 0
            print(f"Filtered to patterns with Power {target} dB")
            self.load_pattern(0)
        except Exception as e:
            print(f"Error filtering by power: {e}")

    def toggle_cell(self, row, col):
        """Manually toggle ON/OFF of an element"""
        self.current_matrix[row][col] ^= 1  # flip 0â†’1 or 1â†’0
        self.send_current_matrix(from_excel=False)


if __name__ == "__main__":
    app = QApplication(sys.argv)
    window = PatternSender()
    window.show()
    sys.exit(app.exec_())
